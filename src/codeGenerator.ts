import { ErrorMessages } from './constants.js';
import type { BaseType } from './types.js';
import { FunctionType, ObjectType } from './types.js';
import { getMemberVarName, isObject, isString } from './utils.js';

export class CodeGenerator {
  static generate(
    typeObj: BaseType,
    langToLangObj: Map<string, unknown>,
    defaultLang: string,
    global: boolean
  ): string {
    const languages = [...langToLangObj.keys()].sort();

    const varLanguages = 'languages';
    const varCurrentLang = 'currentLang';
    const varI18n = 'i18n';
    const varI18nType = 'I18n';

    let code = `/* eslint-disable */

/*----------------------------------------------------------------------------------------------*
 * You MUST NOT modify this file manually because it is automatically generated by gen-i18n-ts. *
 * Modify your JSON files in i18n directory and run "yarn gen-i18n-ts" to regenerate this file. *
 *----------------------------------------------------------------------------------------------*/

`;

    // Generate language union type
    const languageUnion = languages.map((lang) => JSON.stringify(lang)).join(' | ');
    code += `type SupportedLanguage = ${languageUnion};\n\n`;

    let members = '';
    for (const language of languages) {
      const langCode = this.langObjToCode(language, langToLangObj.get(language));
      members += `${JSON.stringify(language)}: ${langCode}, `;
    }
    code += `const ${varLanguages} = { ${members} } as const;\n`;

    if (global) {
      code += `let ${varCurrentLang}: typeof ${varLanguages}[SupportedLanguage] = ${varLanguages}[${JSON.stringify(defaultLang)}];\n`;

      const i18nCode = this.typeObjToCode(typeObj, varCurrentLang);
      code += `export const ${varI18n} = ${i18nCode};\n`;
      code += `export type ${varI18nType} = typeof ${varI18n};\n`;

      code += `${this.generateChangeLanguageCode(languages, varLanguages, varCurrentLang)}\n`;

      code += `${this.generateGetLanguageCode()}\n`;
    } else {
      const i18nCode = this.typeObjToCodeWithLanguageParam(typeObj, varLanguages);
      code += `export const ${varI18n} = ${i18nCode};\n`;
      code += `export type ${varI18nType} = typeof ${varI18n};\n`;
    }

    return code;
  }

  private static langObjToCode(lang: string, langObj: unknown): string {
    if (!isObject(langObj)) throw new Error(ErrorMessages.langFileNotObject(lang));

    return this.langObjToCodeRecursively(lang, langObj, '');
  }

  private static langObjToCodeRecursively(lang: string, langObj: unknown, varName: string): string {
    if (isString(langObj)) {
      return JSON.stringify(langObj);
    } else if (isObject(langObj)) {
      let members = '';
      for (const [key, value] of Object.entries(langObj)) {
        const memberVarName = getMemberVarName(varName, key);
        const valueCode = this.langObjToCodeRecursively(lang, value, memberVarName);
        members += `${JSON.stringify(key)}: ${valueCode}, `;
      }
      return `{ "__code__": "${lang}", ${members} }`;
    }

    throw new Error(ErrorMessages.varShouldStringOrObject(lang, varName));
  }

  private static typeObjToCodeWithLanguageParam(typeObj: BaseType, varLanguages: string): string {
    const varLanguage = 'language';
    const varCurrentLang = 'currentLang';

    let code = `function (${varLanguage}: string) {\n`;
    code += `  if (!(${varLanguage} in ${varLanguages})) throw new Error(\`Language "\${${varLanguage}}" not found\`);\n`;
    code += `  const ${varCurrentLang} = ${varLanguages}[${varLanguage} as SupportedLanguage];\n`;

    const i18nCode = this.typeObjToCode(typeObj, varCurrentLang);
    code += `  return ${i18nCode};\n`;
    code += `}`;

    return code;
  }

  private static typeObjToCode(typeObj: BaseType, varName: string): string {
    if (typeObj instanceof FunctionType) {
      if (typeObj.params.length === 0) {
        const declaration = `function (): string`;
        return `${declaration} { return ${varName} }`;
      }

      const paramTypes = typeObj.params.map((param) => `${param}: unknown`).join(', ');
      const paramDestructure = `{ ${typeObj.params.join(', ')} }`;
      const declaration = `function (${paramDestructure}: { ${paramTypes} }): string`;

      const varParamMap = 'paramMap';
      const members = typeObj.params.map((param) => `"\${${param}}" : String(${param}),`).join(' ');
      const declarationStatement = `const ${varParamMap}: Record<string, string> = { ${members} };`;

      const varPattern = 'pattern';
      const patterns = typeObj.params.map((param) => `\\$\\{${param}\\}`).join('|');
      const regex = `/${patterns}/g`;
      const replaceFunc = `(${varPattern}) => ${varParamMap}[${varPattern}] ?? ''`;
      const returnStatement = `return ${varName}.replace(${regex}, ${replaceFunc});`;

      return `${declaration} { ${declarationStatement} ${returnStatement} }`;
    } else if (typeObj instanceof ObjectType) {
      let members = '';
      for (const [key, value] of Object.entries(typeObj.map)) {
        const memberVarName = getMemberVarName(varName, key);
        const valueCode = this.typeObjToCode(value, memberVarName);
        members += `${JSON.stringify(key)}: ${valueCode}, `;
      }
      return `{ ${members} }`;
    } else {
      throw new TypeError(ErrorMessages.unreachable());
    }
  }

  private static generateChangeLanguageCode(langs: string[], varLanguages: string, varCurrentLang: string): string {
    const funcChangeCurrentLang = 'changeLanguageByCode';
    const varLang = 'lang';
    const declaration = `export function ${funcChangeCurrentLang}(${varLang}: SupportedLanguage): true;\nexport function ${funcChangeCurrentLang}(${varLang}: string): boolean;\nexport function ${funcChangeCurrentLang}(${varLang}: string): boolean`;

    const cases = langs
      .map((lang) => `case "${lang}": ${varCurrentLang} = ${varLanguages}[${JSON.stringify(lang)}]; return true;`)
      .join(' ');
    const statement = `switch (${varLang}) { ${cases} } return false;`;

    return `${declaration} { ${statement} }`;
  }

  private static generateGetLanguageCode(): string {
    return `export function getCurrentLanguageCode(): string {
  return currentLang.__code__;
}
export function getFullAndShortLanguageCodeList(): string[] {
  const langSet = new Set<string>();
  const fullLangs = getFullLanguageCodeList();
  const shortLangs = getShortLanguageCodeList();
  const length = Math.max(fullLangs.length, shortLangs.length);
  for (let i = 0; i < length; i++) {
    const fullLang = fullLangs[i];
    if (fullLang) langSet.add(fullLang);
    const shortLang = shortLangs[i];
    if (shortLang) langSet.add(shortLang);
  }
  return [...langSet];
}
export function getFullLanguageCodeList(): string[] {
  const langSet = new Set<string>();
  const nav = window.navigator || {};
  if (Array.isArray(nav.languages)) {
    for (const lang of nav.languages) {
      if (lang) langSet.add(lang);
    }
  }
  for (const key of ['language', 'browserLanguage', 'systemLanguage', 'userLanguage']) {
    const lang = (nav as any)[key];
    if (lang) langSet.add(lang);
  }
  return [...langSet];
}
export function getShortLanguageCodeList(): string[] {
  return [...new Set(getFullLanguageCodeList().map(lang => lang.split('-')[0] ?? '').filter(lang => !!lang))];
}
export function i18nByCode(langCode: string): typeof i18n {
  changeLanguageByCode(langCode);
  return i18n;
}`;
  }
}
